# 中国建筑（601668.SH）月级波段交易策略

## 策略概述

本策略是一个基于技术指标的月线级别波段交易系统，专门针对中国建筑（601668.SH）设计。策略综合运用MACD、移动平均线、RSI和成交量等多个技术指标，实现趋势跟踪和风险控制。

## 策略逻辑

### 入场信号（三个条件必须同时满足）

1. **MACD金叉**：月线MACD快线（DIF）上穿慢线（DEA）
2. **价格突破**：收盘价站稳月线MA60（收盘价 > MA60）
3. **成交量放大**：当月成交量较前3个月均值放大30%以上

### 出场信号（满足任一条件即出场）

1. **技术指标背离**：月线MACD死叉 + RSI(14)超买(>70)
2. **动态止盈**：股价从波段最高点回撤5%
3. **固定止盈**：达到15%固定止盈目标

### 止损规则（满足任一条件立即清仓）

1. **固定止损**：买入后股价跌破入场价8%
2. **均线止损**：跌破月线MA120

### 仓位管理

1. **首次建仓**：使用30%的总资金建仓
2. **加仓条件**：股价回调3%且未触发止损时，加仓20%
3. **最大仓位**：总仓位不超过50%

## 回测配置

### 基础参数

- **初始资金**：1,000,000元（100万）
- **佣金费率**：万2.5（0.00025）
- **滑点**：0.1%
- **数据周期**：月线（日线数据重采样）

### 技术指标参数

| 指标 | 参数 | 说明 |
|------|------|------|
| MACD | (12, 26, 9) | 快线12周期，慢线26周期，信号线9周期 |
| 均线 | MA60, MA120 | 短期60月均线，长期120月均线 |
| RSI | 14 | 14周期相对强弱指标 |
| 成交量 | 3个月均值 | 用于判断放量 |

### 风险控制参数

| 参数 | 数值 | 说明 |
|------|------|------|
| 固定止损 | 8% | 跌破入场价8%止损 |
| 固定止盈 | 15% | 达到15%盈利止盈 |
| 动态止盈 | 5% | 从最高点回撤5%止盈 |
| 加仓回调 | 3% | 回调3%时加仓 |

## 回测结果分析

### 当前回测结果

基于2009年7月至2025年1月的历史数据（187个月线数据点）：

- **总交易次数**：0次
- **原因分析**：三个入场条件同时满足的情况较少

### 信号触发情况

回测期间发现以下接近入场的情况：

1. **2022年11月**：
   - MACD金叉：❌（接近但未金叉）
   - 价格>MA60：✅
   - 成交量放大：✅

2. **2024年9月**：
   - MACD金叉：✅
   - 价格>MA60：✅
   - 成交量放大：❌（仅放大14.6%，未达到30%阈值）

## 参数优化建议

### 1. 入场条件优化

**当前问题**：三个条件同时满足过于严格，导致交易机会少

**优化方案**：

```python
# 方案A：降低成交量阈值
('volume_threshold', 1.2),  # 从1.3降至1.2（放大20%即可）

# 方案B：改为满足2/3条件即可入场
def check_entry_signal_flexible(self):
    conditions = [
        self.macd_crossover[0] > 0,
        self.dataclose[0] > self.ma60[0],
        self.datavolume[0] > self.volume_ma[0] * 1.3
    ]
    return sum(conditions) >= 2  # 满足2个条件即可

# 方案C：增加趋势确认
# 要求MACD金叉后持续2个月保持多头排列
```

### 2. MACD参数优化

**建议测试的参数组合**：

| 组合 | 快线 | 慢线 | 信号线 | 适用场景 |
|------|------|------|--------|----------|
| 激进型 | 8 | 17 | 9 | 捕捉短期趋势 |
| 标准型 | 12 | 26 | 9 | 中期趋势（当前） |
| 保守型 | 19 | 39 | 9 | 长期趋势 |

**参数优化代码示例**：

```python
# 在run_backtest()函数中添加
cerebro.optstrategy(
    MonthlySwingStrategy,
    macd_fast=range(8, 20, 4),      # 测试8, 12, 16
    macd_slow=range(17, 40, 9),     # 测试17, 26, 35
    volume_threshold=[1.2, 1.3, 1.4] # 测试不同阈值
)
```

### 3. 止盈止损优化

**动态止损方案**：

```python
# 基于ATR（平均真实波幅）的动态止损
self.atr = bt.indicators.ATR(self.datas[0], period=14)

def calculate_dynamic_stop_loss(self):
    # 止损距离 = 2倍ATR
    stop_distance = 2 * self.atr[0]
    stop_price = self.entry_price - stop_distance
    return stop_price
```

**分级止盈方案**：

```python
# 盈利5%时，止损移至成本价
# 盈利10%时，止损移至盈利5%
# 盈利15%时，止损移至盈利10%
def trailing_stop_profit(self):
    profit_pct = (self.dataclose[0] - self.entry_price) / self.entry_price
    
    if profit_pct >= 0.15:
        return self.entry_price * 1.10  # 保护10%利润
    elif profit_pct >= 0.10:
        return self.entry_price * 1.05  # 保护5%利润
    elif profit_pct >= 0.05:
        return self.entry_price         # 保护成本
    else:
        return self.entry_price * 0.92  # 8%固定止损
```

### 4. 仓位管理优化

**凯利公式计算最优仓位**：

```python
def kelly_position_size(self, win_rate, avg_win, avg_loss):
    """
    凯利公式：f = (bp - q) / b
    f: 最优仓位比例
    b: 盈亏比（平均盈利/平均亏损）
    p: 胜率
    q: 败率 = 1 - p
    """
    if avg_loss == 0:
        return 0.3  # 默认30%
    
    b = abs(avg_win / avg_loss)
    p = win_rate
    q = 1 - p
    
    kelly = (b * p - q) / b
    
    # 使用半凯利（更保守）
    return max(0.1, min(0.5, kelly * 0.5))
```

**金字塔式加仓**：

```python
# 首次建仓30%
# 盈利3%后加仓10%（总仓位40%）
# 盈利6%后再加仓10%（总仓位50%）
```

### 5. 信号过滤优化

**增加市场环境过滤**：

```python
# 1. 大盘指数过滤
# 只在上证指数月线MA20向上时交易
self.market_index_ma = bt.indicators.SMA(market_data.close, period=20)
market_bullish = market_data.close[0] > self.market_index_ma[0]

# 2. 波动率过滤
# 只在波动率适中时交易（避免极端行情）
self.atr = bt.indicators.ATR(self.datas[0], period=14)
volatility_normal = 0.5 < self.atr[0] / self.dataclose[0] < 2.0

# 3. 趋势强度过滤
# 使用ADX判断趋势强度
self.adx = bt.indicators.ADX(self.datas[0], period=14)
strong_trend = self.adx[0] > 25
```

**增加基本面过滤**：

```python
# 需要外部数据源
fundamental_filters = {
    'pe_ratio': (0, 15),      # 市盈率在0-15之间
    'pb_ratio': (0, 2),       # 市净率在0-2之间
    'roe': (0.1, 1.0),        # ROE大于10%
    'debt_ratio': (0, 0.6),   # 资产负债率小于60%
}
```

### 6. 多因子增强

**构建综合评分系统**：

```python
def calculate_signal_score(self):
    """
    计算综合信号得分（0-100分）
    """
    score = 0
    
    # MACD因子（30分）
    if self.macd_crossover[0] > 0:
        score += 30
    elif self.macd_line[0] > self.signal_line[0]:
        score += 15
    
    # 均线因子（20分）
    if self.dataclose[0] > self.ma60[0]:
        score += 10
    if self.dataclose[0] > self.ma120[0]:
        score += 10
    
    # 成交量因子（20分）
    volume_ratio = self.datavolume[0] / self.volume_ma[0]
    if volume_ratio > 1.5:
        score += 20
    elif volume_ratio > 1.3:
        score += 15
    elif volume_ratio > 1.1:
        score += 10
    
    # 动量因子（15分）
    momentum = (self.dataclose[0] - self.dataclose[-3]) / self.dataclose[-3]
    if momentum > 0.05:
        score += 15
    elif momentum > 0:
        score += 8
    
    # RSI因子（15分）
    if 40 < self.rsi[0] < 60:
        score += 15  # 中性区域
    elif 30 < self.rsi[0] < 70:
        score += 10
    
    return score

# 使用评分系统
def check_entry_signal_with_score(self):
    score = self.calculate_signal_score()
    return score >= 70  # 得分70分以上才入场
```

## 使用方法

### 基础运行

```bash
# 直接运行策略
python3 monthly_swing_strategy.py
```

### 参数调整

在代码中修改`MonthlySwingStrategy`类的`params`：

```python
params = (
    # 调整MACD参数
    ('macd_fast', 8),      # 改为8周期
    ('macd_slow', 17),     # 改为17周期
    
    # 调整成交量阈值
    ('volume_threshold', 1.2),  # 降低至120%
    
    # 调整止盈止损
    ('stop_loss_pct', 0.10),    # 提高止损至10%
    ('take_profit_pct', 0.20),  # 提高止盈至20%
)
```

### 参数优化运行

创建参数优化脚本：

```python
# 在run_backtest()中替换cerebro.addstrategy()
cerebro.optstrategy(
    MonthlySwingStrategy,
    macd_fast=range(8, 20, 4),
    macd_slow=range(17, 40, 9),
    volume_threshold=[1.1, 1.2, 1.3, 1.4, 1.5]
)

# 运行优化
results = cerebro.run()

# 分析最优参数
for result in results:
    strat = result[0]
    print(f'参数: fast={strat.params.macd_fast}, '
          f'slow={strat.params.macd_slow}, '
          f'volume={strat.params.volume_threshold}, '
          f'收益: {strat.broker.getvalue():.2f}')
```

## 风险提示

1. **历史回测不代表未来表现**：过去的收益不能保证未来收益
2. **过度拟合风险**：参数优化可能导致过度拟合历史数据
3. **市场环境变化**：策略在不同市场环境下表现可能差异很大
4. **流动性风险**：月线策略持仓时间长，需要考虑流动性
5. **黑天鹅事件**：极端行情下止损可能无法及时执行

## 实盘建议

1. **小资金测试**：先用小额资金测试策略有效性
2. **严格执行纪律**：严格按照策略信号执行，不要主观干预
3. **定期评估**：每季度评估策略表现，必要时调整参数
4. **风险控制**：
   - 单只股票仓位不超过总资金的50%
   - 设置账户总回撤警戒线（如20%）
   - 保留足够的现金储备
5. **组合投资**：不要把所有资金投入单一策略或单一股票

## 进一步优化方向

1. **机器学习增强**：
   - 使用随机森林或XGBoost预测信号
   - LSTM神经网络预测价格趋势
   - 强化学习优化仓位管理

2. **多品种组合**：
   - 同时交易多只建筑类股票
   - 构建行业轮动策略
   - 实现跨市场套利

3. **高频因子**：
   - 结合日内数据增强信号
   - 使用订单流数据
   - 分析市场微观结构

4. **情绪指标**：
   - 新闻情感分析
   - 社交媒体情绪指标
   - 投资者情绪指数

5. **基本面整合**：
   - 财报数据自动分析
   - 行业景气度指标
   - 宏观经济指标

## 技术支持

如有问题或建议，请参考：

- Backtrader官方文档：https://www.backtrader.com/docu/
- 量化交易社区：https://www.joinquant.com/
- 技术指标详解：https://www.investopedia.com/

---

**免责声明**：本策略仅供学习研究使用，不构成投资建议。投资有风险，入市需谨慎。
