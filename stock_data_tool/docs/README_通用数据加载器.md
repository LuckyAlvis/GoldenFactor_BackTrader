# é€šç”¨CSVæ•°æ®åŠ è½½å™¨ + ç‰¹æ–¯æ‹‰åŒå‡çº¿ç­–ç•¥

## ðŸ“‹ é¡¹ç›®æ¦‚è¿°

æœ¬é¡¹ç›®å®žçŽ°äº†ä¸¤ä¸ªæ ¸å¿ƒåŠŸèƒ½ï¼š
1. **é€šç”¨CSVæ•°æ®åŠ è½½å™¨**ï¼šç»Ÿä¸€å¤„ç†ä¸åŒæ¥æºçš„è‚¡ç¥¨æ•°æ®CSVæ–‡ä»¶
2. **ç‰¹æ–¯æ‹‰åŒå‡çº¿ç­–ç•¥**ï¼šå°†ç»å…¸åŒå‡çº¿ç­–ç•¥åº”ç”¨äºŽç¾Žè‚¡ç‰¹æ–¯æ‹‰

---

## ðŸŽ¯ æ ¸å¿ƒåˆ›æ–°ï¼šç»Ÿä¸€æ•°æ®åŠ è½½å™¨

### é—®é¢˜

ä¸åŒæ•°æ®æºçš„CSVæ ¼å¼å„å¼‚ï¼š
- **Aè‚¡æ•°æ®**ï¼šä¸­æ–‡åˆ—åï¼ŒGBKç¼–ç ï¼Œå¸¦è¯´æ˜Žè¡Œ
- **ç¾Žè‚¡æ•°æ®**ï¼šè‹±æ–‡åˆ—åï¼ŒUTF-8ç¼–ç ï¼Œå¸¦æ—¶åŒº
- **å…¶ä»–æ•°æ®**ï¼šæ ¼å¼ä¸ç»Ÿä¸€

### è§£å†³æ–¹æ¡ˆ

åˆ›å»º `csv_data_loader.py` ç»Ÿä¸€å¤„ç†æ‰€æœ‰æ ¼å¼ï¼š

```python
from csv_data_loader import CSVDataLoader

# ä¸€è¡Œä»£ç åŠ è½½ä»»æ„æ ¼å¼çš„CSV
df = CSVDataLoader.load_csv('your_file.csv')

# è‡ªåŠ¨å®Œæˆï¼š
# âœ… æ£€æµ‹ç¼–ç ï¼ˆUTF-8/GBK/GB2312ï¼‰
# âœ… è·³è¿‡è¯´æ˜Žè¡Œ
# âœ… ç»Ÿä¸€åˆ—åï¼ˆä¸­è‹±æ–‡â†’æ ‡å‡†åï¼‰
# âœ… è§£æžæ—¥æœŸï¼ˆå¤„ç†æ—¶åŒºï¼‰
# âœ… æ¸…æ´—æ•°æ®
# âœ… éªŒè¯å®Œæ•´æ€§
```

---

## ðŸ“ é¡¹ç›®æ–‡ä»¶

```
backtrader/
â”œâ”€â”€ csv_data_loader.py                  # é€šç”¨CSVæ•°æ®åŠ è½½å™¨ â­
â”œâ”€â”€ tesla_dual_ma_strategy.py           # ç‰¹æ–¯æ‹‰åŒå‡çº¿ç­–ç•¥ â­
â”œâ”€â”€ ç‰¹æ–¯æ‹‰åŒå‡çº¿ç­–ç•¥å›žæµ‹æŠ¥å‘Š.md          # è¯¦ç»†å›žæµ‹æŠ¥å‘Š
â”œâ”€â”€ README_é€šç”¨æ•°æ®åŠ è½½å™¨.md            # æœ¬æ–‡ä»¶
â”‚
â”œâ”€â”€ tsla_data.csv                       # ç‰¹æ–¯æ‹‰æ•°æ®
â”œâ”€â”€ sh601668.csv                        # ä¸­å›½å»ºç­‘æ•°æ®
â”œâ”€â”€ sz301622.csv                        # è‹±æ€ç‰¹æ•°æ®
â”‚
â”œâ”€â”€ fetch_tesla_data.py                 # ç‰¹æ–¯æ‹‰æ•°æ®èŽ·å–å·¥å…·
â”œâ”€â”€ fetch_tesla_simple.py               # ç®€åŒ–ç‰ˆæ•°æ®èŽ·å–
â””â”€â”€ ç‰¹æ–¯æ‹‰æ•°æ®èŽ·å–è¯´æ˜Ž.md                # æ•°æ®èŽ·å–æ–‡æ¡£
```

---

## ðŸš€ å¿«é€Ÿå¼€å§‹

### 1. æµ‹è¯•æ•°æ®åŠ è½½å™¨

```bash
python3 csv_data_loader.py
```

**è¾“å‡ºç¤ºä¾‹**ï¼š
```
æ­£åœ¨åŠ è½½CSVæ–‡ä»¶: tsla_data.csv
æ£€æµ‹åˆ°ç¼–ç : utf-8
è·³è¿‡å‰ 1 è¡Œ
åŽŸå§‹åˆ—å: ['Symbol', 'Date', 'Open', 'High', 'Low', 'Close', 'Volume']
æ ‡å‡†åŒ–åˆ—å: ['symbol', 'date', 'open', 'high', 'low', 'close', 'volume']
âœ… æ•°æ®åŠ è½½æˆåŠŸ: 250 è¡Œ
```

### 2. è¿è¡Œç‰¹æ–¯æ‹‰ç­–ç•¥å›žæµ‹

```bash
# å•æ¬¡å›žæµ‹ï¼ˆé»˜è®¤MA5,20ï¼‰
python3 tesla_dual_ma_strategy.py

# å‚æ•°å¯¹æ¯”æµ‹è¯•
python3 tesla_dual_ma_strategy.py compare
```

---

## ðŸ“Š å›žæµ‹ç»“æžœæ±‡æ€»

### ç‰¹æ–¯æ‹‰åŒå‡çº¿ç­–ç•¥è¡¨çŽ°

| å‚æ•°ç»„åˆ | æ”¶ç›ŠçŽ‡ | æœ€å¤§å›žæ’¤ | äº¤æ˜“æ¬¡æ•° | è¯„ä»· |
|----------|--------|----------|----------|------|
| MA(5,10) | -8.35% | 45.97% | 13 | âŒ é¢‘ç¹äº¤æ˜“ |
| MA(5,20) | -9.75% | 31.79% | 6 | âŒ æ”¶ç›Šä¸ºè´Ÿ |
| MA(10,20) | +18.03% | 28.65% | 6 | âœ… æ”¶ç›Šè½¬æ­£ |
| MA(10,30) | +25.28% | 20.01% | 4 | âœ…âœ… å¹³è¡¡è‰¯å¥½ |
| MA(20,60) | +31.76% | 21.01% | 1 | ðŸ† æœ€ä½³ç­–ç•¥ |

**å…³é”®å‘çŽ°**ï¼š
- âœ… é•¿å‘¨æœŸå‚æ•°è¡¨çŽ°æ˜¾è‘—ä¼˜äºŽçŸ­å‘¨æœŸ
- âœ… MA(20,60)èŽ·å¾—31.76%æ”¶ç›Š
- âš ï¸ çŸ­å‘¨æœŸå‚æ•°å®¹æ˜“äº§ç”Ÿå‡ä¿¡å·

---

## ðŸ’¡ æ•°æ®åŠ è½½å™¨ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹1ï¼šåŠ è½½Aè‚¡æ•°æ®

```python
from csv_data_loader import CSVDataLoader

# åŠ è½½ä¸­å›½å»ºç­‘æ•°æ®ï¼ˆGBKç¼–ç ï¼Œä¸­æ–‡åˆ—åï¼‰
df = CSVDataLoader.load_csv('sh601668.csv')

# æŸ¥çœ‹æ ‡å‡†åŒ–åŽçš„æ•°æ®
print(df.head())
#   symbol  name        date  open  high   low  close     volume
# 0 sh601668  ä¸­å›½å»ºç­‘  2009-07-29  6.70  7.96  6.21   6.53  4173160876
```

### ç¤ºä¾‹2ï¼šåŠ è½½ç¾Žè‚¡æ•°æ®

```python
# åŠ è½½ç‰¹æ–¯æ‹‰æ•°æ®ï¼ˆUTF-8ç¼–ç ï¼Œè‹±æ–‡åˆ—åï¼Œå¸¦æ—¶åŒºï¼‰
df = CSVDataLoader.load_csv('tsla_data.csv')

# è‡ªåŠ¨å¤„ç†æ—¶åŒºï¼Œç»Ÿä¸€æ ¼å¼
print(df.head())
#   symbol       date    open    high     low   close    volume
# 0   TSLA 2024-11-11  346.30  358.64  336.00  350.00  210521600
```

### ç¤ºä¾‹3ï¼šè½¬æ¢ä¸ºBacktraderæ ¼å¼

```python
# åŠ è½½æ•°æ®
df = CSVDataLoader.load_csv('tsla_data.csv')

# è½¬æ¢ä¸ºBacktraderæ‰€éœ€æ ¼å¼
bt_df = CSVDataLoader.convert_to_backtrader_format(df)

# ç›´æŽ¥ç”¨äºŽå›žæµ‹
import backtrader as bt
data = bt.feeds.PandasData(dataname=bt_df)
```

### ç¤ºä¾‹4ï¼šä¿å­˜æ ‡å‡†åŒ–æ•°æ®

```python
# åŠ è½½å¹¶æ ‡å‡†åŒ–
df = CSVDataLoader.load_csv('original.csv')

# ä¿å­˜ä¸ºç»Ÿä¸€æ ¼å¼
CSVDataLoader.save_standardized_csv(df, 'standardized.csv')
```

---

## ðŸ”§ æ•°æ®åŠ è½½å™¨æ ¸å¿ƒåŠŸèƒ½

### 1. è‡ªåŠ¨ç¼–ç æ£€æµ‹

```python
@staticmethod
def detect_encoding(file_path):
    """
    è‡ªåŠ¨æ£€æµ‹æ–‡ä»¶ç¼–ç 
    æ”¯æŒï¼šUTF-8, GBK, GB2312, GB18030ç­‰
    """
    encodings = ['utf-8', 'utf-8-sig', 'gbk', 'gb2312', 'gb18030']
    for encoding in encodings:
        try:
            with open(file_path, 'r', encoding=encoding) as f:
                f.read()
            return encoding
        except UnicodeDecodeError:
            continue
    return 'utf-8'
```

### 2. åˆ—åæ˜ å°„

```python
COLUMN_MAPPING = {
    # Aè‚¡æ•°æ®ï¼ˆä¸­æ–‡ï¼‰
    'è‚¡ç¥¨ä»£ç ': 'symbol',
    'äº¤æ˜“æ—¥æœŸ': 'date',
    'å¼€ç›˜ä»·': 'open',
    'æœ€é«˜ä»·': 'high',
    'æœ€ä½Žä»·': 'low',
    'æ”¶ç›˜ä»·': 'close',
    'æˆäº¤é‡': 'volume',
    
    # ç¾Žè‚¡æ•°æ®ï¼ˆè‹±æ–‡ï¼‰
    'Symbol': 'symbol',
    'Date': 'date',
    'Open': 'open',
    'High': 'high',
    'Low': 'low',
    'Close': 'close',
    'Volume': 'volume',
}
```

### 3. æ•°æ®æ¸…æ´—

```python
@staticmethod
def clean_data(df):
    """
    æ¸…æ´—æ•°æ®
    - åˆ é™¤é‡å¤è¡Œ
    - æŒ‰æ—¥æœŸæŽ’åº
    - åˆ é™¤ç¼ºå¤±å€¼
    """
    df = df.drop_duplicates(subset=['date'], keep='last')
    df = df.sort_values('date').reset_index(drop=True)
    df = df.dropna(subset=['date', 'open', 'high', 'low', 'close', 'volume'])
    return df
```

### 4. æ•°æ®éªŒè¯

```python
@staticmethod
def validate_data(df):
    """
    éªŒè¯æ•°æ®å®Œæ•´æ€§
    - æ£€æŸ¥å¿…éœ€åˆ—
    - æ£€æŸ¥æ•°æ®æ˜¯å¦ä¸ºç©º
    - æ£€æŸ¥ä»·æ ¼å’Œæˆäº¤é‡æ˜¯å¦ä¸ºæ­£æ•°
    """
    required = ['date', 'open', 'high', 'low', 'close', 'volume']
    missing = [col for col in required if col not in df.columns]
    if missing:
        raise ValueError(f'ç¼ºå°‘å¿…éœ€åˆ—: {missing}')
    return True
```

---

## ðŸ“ˆ ç­–ç•¥å®žçŽ°ç‰¹ç‚¹

### 1. æ¨¡å—åŒ–è®¾è®¡

```python
# æ•°æ®åŠ è½½ï¼ˆç‹¬ç«‹æ¨¡å—ï¼‰
from csv_data_loader import CSVDataLoader
df = CSVDataLoader.load_csv('tsla_data.csv')

# ç­–ç•¥å®žçŽ°ï¼ˆç‹¬ç«‹æ¨¡å—ï¼‰
class DualMAStrategy(bt.Strategy):
    params = (
        ('ma_short', 5),
        ('ma_long', 20),
    )
    # ... ç­–ç•¥é€»è¾‘
```

### 2. è¯¦ç»†æ—¥å¿—

```python
2025-01-21, ðŸ”” ä¹°å…¥ä¿¡å· - MA5ä¸Šç©¿MA20
2025-01-21, ðŸŽ¯ æ‰§è¡Œä¹°å…¥ - æ•°é‡: 224, ä»·æ ¼: 424.07
2025-01-22, âœ… ä¹°å…¥æ‰§è¡Œ - ä»·æ ¼: 416.81, æ•°é‡: 224
2025-01-28, ðŸ”” å–å‡ºä¿¡å· - MA5ä¸‹ç©¿MA20
2025-01-29, âŒ å–å‡ºæ‰§è¡Œ - ä»·æ ¼: 395.21, æ•°é‡: -224
2025-01-29, ðŸ’° äº¤æ˜“å®Œæˆ #1 - å‡€åˆ©æ¶¦: -5020.29
```

### 3. å‚æ•°å¯¹æ¯”

```python
# ä¸€é”®å¯¹æ¯”å¤šç»„å‚æ•°
python3 tesla_dual_ma_strategy.py compare

# è¾“å‡ºï¼š
# MA(5,10)   -8.35%   45.97%   13æ¬¡
# MA(5,20)   -9.75%   31.79%    6æ¬¡
# MA(10,20) +18.03%   28.65%    6æ¬¡
# MA(10,30) +25.28%   20.01%    4æ¬¡
# MA(20,60) +31.76%   21.01%    1æ¬¡ ðŸ†
```

---

## ðŸŽ“ å­¦ä¹ ä»·å€¼

### 1. é€šç”¨æ•°æ®å¤„ç†

å­¦ä¹ å¦‚ä½•ï¼š
- å¤„ç†ä¸åŒç¼–ç çš„æ–‡ä»¶
- ç»Ÿä¸€ä¸åŒæ ¼å¼çš„æ•°æ®
- è®¾è®¡å¯æ‰©å±•çš„æ•°æ®æŽ¥å£
- å®žçŽ°æ•°æ®éªŒè¯å’Œæ¸…æ´—

### 2. ç­–ç•¥å¼€å‘æµç¨‹

å­¦ä¹ å¦‚ä½•ï¼š
- ä»Žç®€å•ç­–ç•¥å¼€å§‹
- è¿›è¡Œå‚æ•°ä¼˜åŒ–
- å¯¹æ¯”ä¸åŒç­–ç•¥è¡¨çŽ°
- åˆ†æžå›žæµ‹ç»“æžœ

### 3. ä»£ç è®¾è®¡æ¨¡å¼

å­¦ä¹ å¦‚ä½•ï¼š
- æ¨¡å—åŒ–è®¾è®¡
- å•ä¸€èŒè´£åŽŸåˆ™
- æŽ¥å£æŠ½è±¡
- é”™è¯¯å¤„ç†

---

## ðŸ” æµ‹è¯•éªŒè¯

### å·²æµ‹è¯•çš„æ•°æ®æº

| æ•°æ®æº | æ ¼å¼ | ç¼–ç  | è¡Œæ•° | çŠ¶æ€ |
|--------|------|------|------|------|
| ä¸­å›½å»ºç­‘ | ä¸­æ–‡åˆ—å | GBK | 3,756 | âœ… |
| ç‰¹æ–¯æ‹‰ | è‹±æ–‡åˆ—å | UTF-8 | 250 | âœ… |
| è‹±æ€ç‰¹ | ä¸­æ–‡åˆ—å | GBK | 34 | âœ… |

### æµ‹è¯•ç»“æžœ

```bash
$ python3 csv_data_loader.py

æµ‹è¯•æ–‡ä»¶: sh601668.csv
âœ… æ•°æ®åŠ è½½æˆåŠŸ: 3756 è¡Œ
âœ… æ ‡å‡†åŒ–æ•°æ®å·²ä¿å­˜

æµ‹è¯•æ–‡ä»¶: tsla_data.csv
âœ… æ•°æ®åŠ è½½æˆåŠŸ: 250 è¡Œ
âœ… æ ‡å‡†åŒ–æ•°æ®å·²ä¿å­˜

æµ‹è¯•æ–‡ä»¶: sz301622.csv
âœ… æ•°æ®åŠ è½½æˆåŠŸ: 34 è¡Œ
âœ… æ ‡å‡†åŒ–æ•°æ®å·²ä¿å­˜
```

---

## ðŸ’» ä»£ç ç¤ºä¾‹

### å®Œæ•´çš„å›žæµ‹æµç¨‹

```python
from csv_data_loader import CSVDataLoader
import backtrader as bt

# 1. åŠ è½½æ•°æ®ï¼ˆè‡ªåŠ¨å¤„ç†æ ¼å¼ï¼‰
df = CSVDataLoader.load_csv('tsla_data.csv')

# 2. è½¬æ¢ä¸ºBacktraderæ ¼å¼
bt_df = CSVDataLoader.convert_to_backtrader_format(df)

# 3. åˆ›å»ºå›žæµ‹å¼•æ“Ž
cerebro = bt.Cerebro()

# 4. æ·»åŠ ç­–ç•¥
cerebro.addstrategy(DualMAStrategy, ma_short=20, ma_long=60)

# 5. æ·»åŠ æ•°æ®
data = bt.feeds.PandasData(dataname=bt_df)
cerebro.adddata(data)

# 6. è®¾ç½®å‚æ•°
cerebro.broker.setcash(100000.0)
cerebro.broker.setcommission(commission=0.001)

# 7. è¿è¡Œå›žæµ‹
results = cerebro.run()

# 8. æŸ¥çœ‹ç»“æžœ
print(f'æœŸæœ«èµ„é‡‘: {cerebro.broker.getvalue():.2f}')
```

---

## ðŸ› ï¸ æ‰©å±•å»ºè®®

### 1. æ”¯æŒæ›´å¤šæ•°æ®æº

```python
# æ·»åŠ æ–°çš„åˆ—åæ˜ å°„
COLUMN_MAPPING.update({
    'timestamp': 'date',
    'o': 'open',
    'h': 'high',
    'l': 'low',
    'c': 'close',
    'v': 'volume',
})
```

### 2. å¢žåŠ æ•°æ®éªŒè¯è§„åˆ™

```python
@staticmethod
def validate_price_logic(df):
    """éªŒè¯ä»·æ ¼é€»è¾‘"""
    # High >= Low
    # High >= Open, Close
    # Low <= Open, Close
    pass
```

### 3. æ”¯æŒæ•°æ®åº“å­˜å‚¨

```python
@staticmethod
def save_to_database(df, table_name):
    """ä¿å­˜åˆ°æ•°æ®åº“"""
    import sqlite3
    conn = sqlite3.connect('stock_data.db')
    df.to_sql(table_name, conn, if_exists='replace')
```

---

## ðŸ“š ç›¸å…³æ–‡æ¡£

- **ç‰¹æ–¯æ‹‰åŒå‡çº¿ç­–ç•¥å›žæµ‹æŠ¥å‘Š.md**ï¼šè¯¦ç»†çš„å›žæµ‹åˆ†æž
- **ç‰¹æ–¯æ‹‰æ•°æ®èŽ·å–è¯´æ˜Ž.md**ï¼šå¦‚ä½•èŽ·å–ç¾Žè‚¡æ•°æ®
- **æœˆçº§æ³¢æ®µç­–ç•¥è¯´æ˜Ž.md**ï¼šä¸­å›½å»ºç­‘ç­–ç•¥æ–‡æ¡£
- **README.md**ï¼šé¡¹ç›®æ€»ä½“è¯´æ˜Ž

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### æ•°æ®åŠ è½½å™¨

1. **ç¼–ç æ£€æµ‹**ï¼šè‡ªåŠ¨æ£€æµ‹ï¼Œä½†æžå°‘æ•°æƒ…å†µå¯èƒ½å¤±è´¥
2. **åˆ—åæ˜ å°„**ï¼šéœ€è¦åŒ…å«å¿…éœ€åˆ—ï¼ˆdate, open, high, low, close, volumeï¼‰
3. **æ—¥æœŸæ ¼å¼**ï¼šæ”¯æŒå¤šç§æ ¼å¼ï¼Œè‡ªåŠ¨è§£æž
4. **æ—¶åŒºå¤„ç†**ï¼šè‡ªåŠ¨ç§»é™¤æ—¶åŒºä¿¡æ¯

### ç­–ç•¥å›žæµ‹

1. **æ•°æ®è´¨é‡**ï¼šç¡®ä¿æ•°æ®å®Œæ•´æ— è¯¯
2. **å‚æ•°é€‰æ‹©**ï¼šä¸åŒå¸‚åœºéœ€è¦ä¸åŒå‚æ•°
3. **è¿‡æ‹Ÿåˆé£Žé™©**ï¼šé¿å…è¿‡åº¦ä¼˜åŒ–
4. **å®žç›˜å·®å¼‚**ï¼šå›žæµ‹ç»“æžœä¸ç­‰äºŽå®žç›˜è¡¨çŽ°

---

## ðŸŽ¯ æœ€ä½³å®žè·µ

### æ•°æ®å¤„ç†

```python
# âœ… æŽ¨èï¼šä½¿ç”¨ç»Ÿä¸€åŠ è½½å™¨
df = CSVDataLoader.load_csv('file.csv')

# âŒ ä¸æŽ¨èï¼šæ‰‹åŠ¨å¤„ç†æ¯ç§æ ¼å¼
if file.endswith('.csv'):
    if encoding == 'gbk':
        df = pd.read_csv(file, encoding='gbk', skiprows=1)
        df.rename(columns={'äº¤æ˜“æ—¥æœŸ': 'date'})
    elif encoding == 'utf-8':
        # ... é‡å¤ä»£ç 
```

### ç­–ç•¥å¼€å‘

```python
# âœ… æŽ¨èï¼šå‚æ•°åŒ–è®¾è®¡
class Strategy(bt.Strategy):
    params = (('ma_short', 5), ('ma_long', 20))

# âŒ ä¸æŽ¨èï¼šç¡¬ç¼–ç 
class Strategy(bt.Strategy):
    def __init__(self):
        self.ma5 = bt.indicators.SMA(period=5)
        self.ma20 = bt.indicators.SMA(period=20)
```

---

## ðŸ“ æ›´æ–°æ—¥å¿—

### v1.0 (2025-11)
- âœ… å®žçŽ°é€šç”¨CSVæ•°æ®åŠ è½½å™¨
- âœ… æ”¯æŒAè‚¡å’Œç¾Žè‚¡æ•°æ®æ ¼å¼
- âœ… å®žçŽ°ç‰¹æ–¯æ‹‰åŒå‡çº¿ç­–ç•¥
- âœ… å®Œæˆå‚æ•°å¯¹æ¯”æµ‹è¯•
- âœ… ç¼–å†™è¯¦ç»†æ–‡æ¡£

---

## ðŸ“§ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œæ¬¢è¿Žåé¦ˆï¼

---

**æœ€åŽæ›´æ–°**ï¼š2025å¹´11æœˆ  
**ç‰ˆæœ¬**ï¼šv1.0  
**ä½œè€…**ï¼šIvan

**å…è´£å£°æ˜Ž**ï¼šæœ¬é¡¹ç›®ä»…ä¾›å­¦ä¹ ç ”ç©¶ä½¿ç”¨ï¼Œä¸æž„æˆæŠ•èµ„å»ºè®®ã€‚æŠ•èµ„æœ‰é£Žé™©ï¼Œå…¥å¸‚éœ€è°¨æ…Žã€‚
