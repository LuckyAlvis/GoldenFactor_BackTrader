# 环境配置指南

## 问题总结

在运行项目时遇到了两类问题：

### 1. 编码问题（Windows/PyCharm）
```
UnicodeEncodeError: 'gbk' codec can't encode character '\u2705'
```

### 2. 依赖问题
- NumPy版本不兼容（NumPy 2.x与旧版pandas冲突）
- 缺少yfinance模块
- 缺少pymysql模块

---

## 解决方案

### 方案A：使用系统Python（推荐）✅

你当前使用的是系统Python 3.10，已经配置好了所有依赖。

#### 1. 检查Python版本

```bash
python3 --version
# 应该显示：Python 3.10.x
```

#### 2. 验证依赖

```bash
python3 -c "import yfinance; import pandas; import pymysql; print('All OK')"
```

#### 3. 运行脚本

```bash
# 在终端运行
cd /Users/ivan/code/QuantProject/backtrader
python3 auto_save_tesla_to_mysql.py
```

**优点**：
- ✅ 已配置好所有依赖
- ✅ NumPy版本兼容
- ✅ 无需额外配置

---

### 方案B：配置Anaconda环境

你的Anaconda环境有NumPy版本冲突问题。

#### 1. 降级NumPy

```bash
# 激活base环境
conda activate base

# 降级NumPy到1.x版本
pip install "numpy<2" --upgrade

# 或使用conda
conda install numpy=1.26
```

#### 2. 安装缺失的包

```bash
# 安装yfinance
pip install yfinance

# 安装pymysql
pip install pymysql
```

#### 3. 验证安装

```bash
python -c "import yfinance; import pandas; import pymysql; import numpy; print(f'NumPy: {numpy.__version__}')"
```

#### 4. 在PyCharm中配置

1. 打开 PyCharm
2. File → Settings → Project → Python Interpreter
3. 选择 Anaconda 的 Python 解释器
4. 确认已安装：yfinance, pandas, pymysql, numpy<2

---

### 方案C：创建新的虚拟环境（最稳定）

#### 使用conda创建

```bash
# 创建新环境
conda create -n quant python=3.10

# 激活环境
conda activate quant

# 安装依赖
pip install yfinance pandas pymysql "numpy<2"

# 验证
python -c "import yfinance; import pandas; import pymysql; print('OK')"
```

#### 使用venv创建

```bash
# 创建虚拟环境
cd /Users/ivan/code/QuantProject/backtrader
python3 -m venv venv

# 激活环境
source venv/bin/activate

# 安装依赖
pip install yfinance pandas pymysql

# 验证
python -c "import yfinance; import pandas; import pymysql; print('OK')"
```

---

## 依赖清单

### 必需的包

| 包名 | 版本要求 | 用途 |
|------|---------|------|
| yfinance | >=0.2.0 | 获取股票数据 |
| pandas | >=1.3.0 | 数据处理 |
| numpy | <2.0 | 数值计算（必须<2.0） |
| pymysql | >=1.0.0 | MySQL连接 |

### 可选的包

| 包名 | 用途 |
|------|------|
| matplotlib | 数据可视化 |
| backtrader | 策略回测 |

---

## 快速安装脚本

### 一键安装所有依赖

```bash
pip3 install yfinance pandas pymysql "numpy<2"
```

### 使用requirements.txt

创建 `requirements.txt`：
```
yfinance>=0.2.0
pandas>=1.3.0,<3.0
numpy>=1.20.0,<2.0
pymysql>=1.0.0
```

安装：
```bash
pip3 install -r requirements.txt
```

---

## 常见问题

### Q1: NumPy版本冲突

**错误信息**：
```
A module that was compiled using NumPy 1.x cannot be run in NumPy 2.3.3
```

**解决方案**：
```bash
pip install "numpy<2" --upgrade
```

### Q2: ModuleNotFoundError: No module named 'yfinance'

**解决方案**：
```bash
pip3 install yfinance
```

### Q3: ModuleNotFoundError: No module named 'pymysql'

**解决方案**：
```bash
pip3 install pymysql
```

### Q4: PyCharm中运行失败，终端运行成功

**原因**：PyCharm使用的Python解释器与终端不同

**解决方案**：
1. 打开 PyCharm
2. File → Settings → Project → Python Interpreter
3. 点击齿轮图标 → Add
4. 选择 System Interpreter
5. 选择 `/usr/local/bin/python3` 或 `/Library/Frameworks/Python.framework/Versions/3.10/bin/python3`

### Q5: 编码错误（GBK无法编码emoji）

**解决方案**：
已修复所有文件，将emoji替换为ASCII字符。

---

## 验证环境

### 完整验证脚本

创建 `check_env.py`：

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""环境检查脚本"""

import sys

def check_python_version():
    """检查Python版本"""
    version = sys.version_info
    print(f"Python版本: {version.major}.{version.minor}.{version.micro}")
    if version.major == 3 and version.minor >= 8:
        print("[OK] Python版本符合要求")
        return True
    else:
        print("[ERROR] Python版本过低，需要3.8+")
        return False

def check_packages():
    """检查依赖包"""
    packages = {
        'yfinance': 'yfinance',
        'pandas': 'pandas',
        'numpy': 'numpy',
        'pymysql': 'pymysql'
    }
    
    all_ok = True
    for name, import_name in packages.items():
        try:
            module = __import__(import_name)
            version = getattr(module, '__version__', 'unknown')
            print(f"[OK] {name}: {version}")
            
            # 检查numpy版本
            if name == 'numpy':
                major = int(version.split('.')[0])
                if major >= 2:
                    print(f"[WARN] NumPy版本过高({version})，建议使用1.x版本")
                    all_ok = False
        except ImportError:
            print(f"[ERROR] {name}: 未安装")
            all_ok = False
    
    return all_ok

def test_yfinance():
    """测试yfinance"""
    try:
        import yfinance as yf
        ticker = yf.Ticker('AAPL')
        info = ticker.info
        if info:
            print(f"[OK] yfinance测试成功: {info.get('longName', 'N/A')}")
            return True
        else:
            print("[ERROR] yfinance测试失败")
            return False
    except Exception as e:
        print(f"[ERROR] yfinance测试失败: {e}")
        return False

def main():
    print("="*60)
    print("环境检查")
    print("="*60)
    
    print("\n1. 检查Python版本...")
    python_ok = check_python_version()
    
    print("\n2. 检查依赖包...")
    packages_ok = check_packages()
    
    print("\n3. 测试yfinance...")
    yfinance_ok = test_yfinance()
    
    print("\n" + "="*60)
    if python_ok and packages_ok and yfinance_ok:
        print("[SUCCESS] 环境配置正确，可以运行项目！")
    else:
        print("[ERROR] 环境配置有问题，请按照上面的提示修复")
    print("="*60)

if __name__ == '__main__':
    main()
```

运行：
```bash
python3 check_env.py
```

---

## 推荐配置

### 开发环境推荐

| 场景 | 推荐方案 | 说明 |
|------|---------|------|
| 日常使用 | 系统Python 3.10 | 简单，已配置好 |
| 多项目开发 | conda环境 | 隔离，易管理 |
| 生产部署 | venv虚拟环境 | 轻量，可复制 |

### PyCharm配置推荐

1. **使用系统Python**（最简单）
   - Interpreter: `/Library/Frameworks/Python.framework/Versions/3.10/bin/python3`
   
2. **使用conda环境**
   - Interpreter: `/opt/anaconda3/envs/quant/bin/python`
   
3. **使用venv**
   - Interpreter: `/Users/ivan/code/QuantProject/backtrader/venv/bin/python`

---

## 当前状态

### 你的环境

| 项目 | 状态 |
|------|------|
| 系统Python 3.10 | ✅ 配置完成 |
| yfinance | ✅ 已安装 |
| pandas | ✅ 已安装 |
| numpy | ✅ 1.26.4（兼容） |
| pymysql | ✅ 已安装 |
| 编码问题 | ✅ 已修复 |

### Anaconda环境

| 项目 | 状态 |
|------|------|
| Python 3.12 | ✅ 可用 |
| numpy | ⚠️ 2.3.3（需降级） |
| pandas | ⚠️ 版本冲突 |
| yfinance | ❌ 未安装 |
| pymysql | ✅ 已安装 |

---

## 建议

### 短期建议

**使用系统Python运行脚本**：
```bash
# 在终端运行
python3 auto_save_tesla_to_mysql.py
python3 us_stock_examples.py
```

### 长期建议

**创建专用的conda环境**：
```bash
conda create -n quant python=3.10
conda activate quant
pip install yfinance pandas pymysql "numpy<2"
```

然后在PyCharm中选择这个环境作为解释器。

---

**更新时间**：2025年11月11日  
**状态**：✅ 所有问题已解决
